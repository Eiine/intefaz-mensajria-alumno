<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { height: 100vh; }
        .sidebar { 
            width: 280px; 
            height: 100%; 
            overflow-y: auto; 
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }
        .chat-area { flex: 1; display: flex; flex-direction: column; height: 100%; }
        .messages { flex: 1; overflow-y: auto; padding: 15px; }
        .message { margin-bottom: 10px; padding: 8px; border-radius: 10px; background: #f1f1f1; }
        .selected { background-color: #e0e0ff; }
        .filtro-btn { margin-right: 5px; margin-bottom: 5px; }
        
        /* Mejoras del sidebar */
        #alumnosList {
            max-height: calc(100vh - 450px);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #0d6efd #f8f9fa;
        }
        
        #alumnosList::-webkit-scrollbar {
            width: 8px;
        }
        
        #alumnosList::-webkit-scrollbar-track {
            background: #f8f9fa;
        }
        
        #alumnosList::-webkit-scrollbar-thumb {
            background: #0d6efd;
            border-radius: 4px;
        }
        
        #alumnosList li[data-alumno-id]:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
        
        #alumnosList li.active {
            background-color: #0d6efd !important;
            color: white !important;
            border-color: #0d6efd !important;
        }
        
        #alumnosList li.active .text-muted {
            color: rgba(255, 255, 255, 0.8) !important;
        }
        
        #alumnosList li.active .badge {
            background-color: rgba(255, 255, 255, 0.3) !important;
            color: white !important;
        }
        
        #searchUser:not(:placeholder-shown) {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        
        .sidebar .badge {
            font-size: 0.7rem;
            padding: 0.25em 0.5em;
        }
        
        .badge {
            transition: all 0.3s ease;
        }
    </style>
</head>
<body style="padding-top: 70px;">
    {% include "mensajes/navbar.html" %}
<div class="d-flex vh-100">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- SIDEBAR CON FILTROS MEJORADO -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="sidebar bg-light border-end">
        
        <!-- HEADER DEL SIDEBAR -->
        <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
            <h5 class="mb-0">Usuarios</h5>
            {% if filtros_activos %}
                <span class="badge bg-primary">
                    <i class="bi bi-funnel-fill"></i> {{ total_alumnos }}
                </span>
            {% else %}
                <span class="badge bg-secondary">{{ total_alumnos }}</span>
            {% endif %}
        </div>
        
        <!-- FORMULARIO DE FILTROS -->
        <div class="px-3 pt-3 pb-2">
            <form method="GET" action="{% url 'panel_admin' %}" id="filtrosForm">
                
                <!-- B√öSQUEDA POR TEXTO -->
                <div class="mb-2">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input 
                            type="text" 
                            id="searchUser" 
                            name="q"
                            class="form-control" 
                            placeholder="Nombre, DNI, tel√©fono, email..." 
                            value="{{ query }}"
                            autocomplete="off"
                        >
                        {% if query %}
                            <a href="{% url 'panel_admin' %}?carrera={{ carrera_seleccionada }}&estado={{ estado_seleccionado }}" 
                               class="btn btn-outline-secondary btn-sm"
                               title="Limpiar b√∫squeda">
                                <i class="bi bi-x"></i>
                            </a>
                        {% endif %}
                    </div>
                </div>
                
                <!-- FILTRO POR CARRERA -->
                <div class="mb-2">
                    <select 
                        class="form-select form-select-sm" 
                        id="filtroCarrera" 
                        name="carrera"
                        title="Filtrar por carrera"
                    >
                        <option value="">üìö Todas las carreras</option>
                        {% for carrera in carreras %}
                            <option 
                                value="{{ carrera.id }}" 
                                {% if carrera.id|stringformat:"s" == carrera_seleccionada %}selected{% endif %}
                            >
                                {{ carrera.codigo }} - {{ carrera.nombre|truncatewords:3 }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- FILTRO POR ESTADO -->
                <!-- <div class="mb-2">
                    <select 
                        class="form-select form-select-sm" 
                        id="filtroEstado" 
                        name="estado"
                        title="Filtrar por estado"
                    >
                        <option value="">‚ö° Todos los estados</option>
                        <option value="activo" {% if estado_seleccionado == 'activo' %}selected{% endif %}>
                            ‚úÖ Activos
                        </option>
                        <option value="inactivo" {% if estado_seleccionado == 'inactivo' %}selected{% endif %}>
                            ‚ùå Inactivos
                        </option>
                    </select>
                </div> -->
                
                <!-- BOTONES DE ACCI√ìN -->
                <div class="d-grid gap-1">
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="bi bi-funnel-fill"></i> Aplicar Filtros
                    </button>
                    {% if filtros_activos %}
                        <a href="{% url 'panel_admin' %}" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-arrow-counterclockwise"></i> Limpiar Todo
                        </a>
                    {% endif %}
                </div>
                
            </form>
        </div>
        
        <!-- INDICADOR DE FILTROS ACTIVOS -->
        {% if filtros_activos %}
            <div class="px-3 pb-2">
                <div class="alert alert-info alert-dismissible fade show py-2 mb-0" role="alert" style="font-size: 0.85rem;">
                    <strong><i class="bi bi-info-circle"></i> Filtros activos:</strong><br>
                    {% if query %}
                        <span class="badge bg-success me-1">B√∫squeda: "{{ query }}"</span>
                    {% endif %}
                    {% if carrera_seleccionada %}
                        {% for carrera in carreras %}
                            {% if carrera.id|stringformat:"s" == carrera_seleccionada %}
                                <span class="badge bg-info me-1">{{ carrera.codigo }}</span>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    {% if estado_seleccionado %}
                        <span class="badge bg-warning text-dark">{{ estado_seleccionado|capfirst }}</span>
                    {% endif %}
                </div>
            </div>
        {% endif %}
        
        <!-- LISTA DE ALUMNOS -->
        <ul id="alumnosList" class="list-group list-group-flush">
            {% for alumno in alumnos %}
                <li class="list-group-item {% if alumno == alumno_seleccionado %}active{% endif %}" 
                    data-alumno-id="{{ alumno.id }}">
                    
                    <!-- NOMBRE DEL ALUMNO -->
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="fw-bold">
                                {{ alumno.user.first_name }} {{ alumno.user.last_name }}
                            </div>
                            <small class="text-muted d-block">
                                <i class="bi bi-card-text"></i> DNI: {{ alumno.dni }}
                            </small>
                        </div>
                        
                        <!-- BADGES -->
                        <div class="text-end">
                            <span class="badge bg-secondary" style="font-size: 0.7rem;">
                                {{ alumno.carrera.codigo }}
                            </span>
                            {% if not alumno.activo %}
                                <span class="badge bg-danger" style="font-size: 0.7rem;">
                                    <i class="bi bi-x-circle"></i>
                                </span>
                            {% endif %}
                        </div>
                    </div>
                    
                </li>
            {% empty %}
                <li class="list-group-item text-center text-muted py-5">
                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                    <p class="mb-1 mt-2"><strong>No se encontraron alumnos</strong></p>
                    <small>
                        {% if filtros_activos %}
                            Intenta con otros filtros o 
                            <a href="{% url 'panel_admin' %}" class="alert-link">limpia los filtros</a>
                        {% else %}
                            No hay alumnos registrados
                        {% endif %}
                    </small>
                </li>
            {% endfor %}
        </ul>
        
        <!-- PIE DEL SIDEBAR -->
        <div class="border-top p-2 text-center" style="font-size: 0.8rem;">
            <small class="text-muted">
                Mostrando {{ alumnos.count }} de {{ total_alumnos }} alumno(s)
            </small>
        </div>
        
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- GRILLA CENTRAL DE NOTIFICACIONES -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="chat-area d-flex flex-column flex-grow-1">
        <div class="messages flex-grow-1 p-3" style="overflow-y: auto;">
            <!-- MENSAJE INICIAL -->
            <p id="mensaje-inicial" class="text-muted">
                Para ver las notificaciones, selecciona un alumno.
            </p>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const searchInput = document.getElementById("searchUser");
    const alumnosList = document.getElementById("alumnosList");
    const items = alumnosList.getElementsByTagName("li");
    const messagesDiv = document.querySelector(".messages");
    const mensajeInicial = document.getElementById("mensaje-inicial");
    const form = document.getElementById('filtrosForm');
    const filtroCarrera = document.getElementById('filtroCarrera');
    const filtroEstado = document.getElementById('filtroEstado');

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 1. FILTROS AUTOM√ÅTICOS AL CAMBIAR DESPLEGABLES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    if (filtroCarrera) {
        filtroCarrera.addEventListener('change', function() {
            form.submit();
        });
    }
    
    if (filtroEstado) {
        filtroEstado.addEventListener('change', function() {
            form.submit();
        });
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 2. B√öSQUEDA CON DELAY (500MS)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let timeoutId;
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(timeoutId);
            const query = this.value.trim();
            
            timeoutId = setTimeout(function() {
                // Solo buscar si hay al menos 2 caracteres o si est√° vac√≠o
                if (query.length >= 2 || query.length === 0) {
                    form.submit();
                }
            }, 2000 );
        });
        
        // Focus autom√°tico
        searchInput.focus();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // 3. CLICK EN ALUMNO PARA VER NOTIFICACIONES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    Array.from(items).forEach(item => {
        // Solo procesar items con data-alumno-id (no el "empty")
        if (!item.dataset.alumnoId) return;
        
        item.addEventListener("click", function() {
            // Remover active de todos
            Array.from(items).forEach(i => i.classList.remove("active"));
            // Agregar active al seleccionado
            this.classList.add("active");

            const alumnoId = this.dataset.alumnoId;
            
            // Actualizar URL manteniendo los filtros
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('alumno_id', alumnoId);
            
            // Actualizar URL sin recargar la p√°gina
            window.history.pushState({}, '', '?' + urlParams.toString());

            // Cargar notificaciones v√≠a AJAX
            fetch(`/ajax/notificaciones/${alumnoId}/`)
                .then(res => res.json())
                .then(data => {
                    
                    if(data.error){
                        messagesDiv.innerHTML = `<p class="text-danger">${data.error}</p>`;
                        return;
                    }

                    // Ocultar mensaje inicial
                    if(mensajeInicial) mensajeInicial.style.display = "none";

                    let html = `<h5>Notificaciones de ${data.alumno}</h5>`;

                    // Agregar tags de filtrado
                    html += `
                        <div id="filtros" class="mb-3">
                            <button class="btn btn-sm btn-outline-primary filtro-btn" data-tipo="Pago pendiente">Pago pendiente</button>
                            <button class="btn btn-sm btn-outline-primary filtro-btn" data-tipo="Falta documentaci√≥n">Falta documentaci√≥n</button>
                            <button class="btn btn-sm btn-outline-primary filtro-btn" data-tipo="Recordatorio">Recordatorio</button>
                            <button class="btn btn-sm btn-outline-secondary filtro-btn" data-tipo="WhatsApp">WhatsApp</button>
                            <button class="btn btn-sm btn-outline-secondary filtro-btn" data-tipo="Email">Email</button>
                            <button class="btn btn-sm btn-outline-primary filtro-btn" data-tipo="Todos">Todos</button>
                        </div>
                    `;

                    if(data.notificaciones.length > 0){
                        data.notificaciones.forEach(n => {
                            html += `
                                <div class="message border rounded p-2 mb-2" data-tipo="${n.tipo}" data-canal="${n.canal}">
                                    <div class="d-flex justify-content-between">
                                        <strong>${n.tipo}</strong>
                                        <small class="text-muted">${n.fecha_envio}</small>
                                    </div>
                                    <p>${n.mensaje}</p>
                                    <p><strong>Canal:</strong> ${n.canal} | <strong>Estado:</strong> ${n.estado_envio}</p>
                                </div>
                            `;
                        });
                    } else {
                        html += `<p class="text-muted">Este alumno no tiene notificaciones.</p>`;
                    }

                    messagesDiv.innerHTML = html;

                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // 4. FUNCIONALIDAD DE FILTRADO DE NOTIFICACIONES
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    const filtroBtns = messagesDiv.querySelectorAll(".filtro-btn");
                    
                    filtroBtns.forEach(btn => {
                        btn.addEventListener("click", function() {
                            const tipo = this.dataset.tipo;
                            
                            // Remover active de todos los botones
                            filtroBtns.forEach(b => b.classList.remove('active'));
                            // Agregar active al bot√≥n clickeado
                            this.classList.add('active');
                            
                            const mensajes = messagesDiv.querySelectorAll(".message");
                            
                            mensajes.forEach(m => {
                                if (tipo === "Todos" || m.dataset.tipo === tipo || m.dataset.canal === tipo) {
                                    m.style.display = "";
                                } else {
                                    m.style.display = "none";
                                }
                            });
                        });
                    });

                })
                .catch(err => {
                    console.error(err);
                    messagesDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            Error al cargar notificaciones. Por favor, intenta de nuevo.
                        </div>
                    `;
                });
        });
    });
});
</script>
</body>
</html>