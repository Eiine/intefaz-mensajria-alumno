{% load static %}

<!DOCTYPE html>
<html>
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <title>Reporte de Notificaciones</title>

    <style>
        body {
            font-family: Arial;
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ccc;
        }
        th {
            background: #eee;
        }
        .kpi-box {
            background: #f2f2f2;
            padding: 15px;
            margin: 20px 0;
            border-radius: 6px;
        }
    </style>
</head>

<body style="padding-top: 70px;">

    {% include "mensajes/navbar.html" %}
    
    <h1>ðŸ“Š Reporte de Notificaciones por Tipo de Evento</h1>

    <!-- ================= FILTROS ================= -->
    <form method="GET">

        <label>Fecha inicio:</label>
        <input type="date" name="fecha_inicio" value="{{ f_fecha_inicio }}">

        <label>Fecha fin:</label>
        <input type="date" name="fecha_fin" value="{{ f_fecha_fin }}">

        <label>Carrera:</label>
        <select name="carrera">
            <option value="">Todas</option>
            {% for c in carreras %}
                <option value="{{ c.id }}" 
                    {% if f_carrera == c.id|stringformat:"s" %}selected{% endif %}>
                    {{ c.nombre }}
                </option>
            {% endfor %}
        </select>

        <label>Tipos de evento:</label>
        <select name="tipos" multiple size="3">
            {% for t in tipos %}
                <option value="{{ t.id }}" 
                    {% if t.id|stringformat:"s" in f_tipos %}selected{% endif %}>
                    {{ t.nombre_tipo }}
                </option>
            {% endfor %}
        </select>

        <label>Canal:</label>
        <select name="canal">
            <option value="">Todos</option>
            <option value="Email" {% if f_canal == "Email" %}selected{% endif %}>Email</option>
            <option value="SMS" {% if f_canal == "SMS" %}selected{% endif %}>SMS</option>
            <option value="WhatsApp" {% if f_canal == "WhatsApp" %}selected{% endif %}>WhatsApp</option>
        </select>

        <button type="submit">Filtrar</button>
    </form>

    <!-- ================= INDICADORES ================= -->
    <div class="kpi-box">
        <h3>Indicadores del perÃ­odo</h3>

        <p><strong>Total de notificaciones enviadas:</strong> {{ total_enviadas }}</p>

        {% if tipo_mayor_envios %}
            <p><strong>Tipo con mÃ¡s envÃ­os:</strong>
                {{ tipo_mayor_envios.tipo__nombre_tipo }} ({{ tipo_mayor_envios.total_enviadas }})
            </p>
        {% else %}
            <p>No hay datos.</p>
        {% endif %}
    </div>

    <!-- ================= TABLA ================= -->
    <table>
        <tr>
            <th>Tipo de evento</th>
            <th>Cantidad enviadas</th>
            <th>Cantidad fallidas</th>
        </tr>

        {% for item in resumen %}
        <tr>
            <td>{{ item.tipo__nombre_tipo }}</td>
            <td>{{ item.total_enviadas }}</td>
            <td>{{ item.total_fallidas }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="3">No hay resultados con los filtros aplicados.</td>
        </tr>
        {% endfor %}
    </table>

</body>
</html>