<script>
const tagButtons = document.querySelectorAll('.tag-btn');
const mensajeTextarea = document.getElementById('mensajeTextarea');
const carreraSelectDiv = document.getElementById('carreraSelect');
let tipoSeleccionado = null;

tagButtons.forEach(btn => {
    btn.addEventListener('click', () => {
        // Guardar tipo seleccionado
        tipoSeleccionado = btn.getAttribute('data-tipo');

        // Llenar textarea
        mensajeTextarea.value = btn.getAttribute('data-msg').replace(/\\n/g, '\n');
        mensajeTextarea.focus();

        // Mostrar select de carrera
        carreraSelectDiv.style.display = 'block';
    });
});

document.getElementById("btnEnviar").addEventListener("click", async () => {
    const mensaje = mensajeTextarea.value.trim();
    const carreraSeleccionada = document.getElementById("carrera").value;

    if (!tipoSeleccionado) {
        alert("Debes seleccionar un Tag primero.");
        return;
    }

    if (!mensaje) {
        alert("El mensaje está vacío.");
        return;
    }

    if (!carreraSeleccionada) {
        alert("Debes seleccionar una carrera.");
        return;
    }

    const resp = await fetch("/circular/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
            mensaje: mensaje,
            carrera: carreraSeleccionada,
            nombre_tipo: tipoSeleccionado,
            canal: "Plataforma"   // <-- agregamos el canal explícitamente
        })
    });

    const data = await resp.json();

    if (data.ok) {
        alert("Notificación enviada correctamente");
        mensajeTextarea.value = "";
        tipoSeleccionado = null;
        document.getElementById("carrera").value = "";
    } else {
        alert("Error: " + data.error);
    }
});
</script>
