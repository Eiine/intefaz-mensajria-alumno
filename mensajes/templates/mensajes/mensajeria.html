<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mensajes internos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .usuario-item:hover {
            background-color: #f0f0f0;
            cursor: pointer;
        }

        /* ðŸ”¹ Estilo de resaltado para usuarios con mensajes no leÃ­dos */
        .usuario-item.no-leido {
            background-color: #cce5ff !important; /* celeste claro */
            font-weight: bold;
        }

        #mensajes-container {
            max-height: 500px;
            overflow-y: auto;
        }

        #buscador-usuarios {
            margin-bottom: 10px;
        }
    </style>
</head>
<body style="padding-top: 70px;">
    {% include "mensajes/navbar.html" %}

<div class="container-fluid mt-4">
    <div class="row">
        <!-- ðŸ“‹ Lista de usuarios -->
        <div class="col-md-3 border-end">
            <h5>Alumnos</h5>

            <!-- ðŸ” Buscador -->
            <input type="text" id="buscador-usuarios" class="form-control mb-2" placeholder="Buscar por nombre o DNI...">

            <ul class="list-group" id="usuarios-conversacion">
                <!-- Se cargarÃ¡n los usuarios con conversaciones -->
            </ul>
        </div>

        <!-- ðŸ’¬ Mensajes -->
        <div class="col-md-9">
            <h5 id="titulo-chat">Selecciona un alumno para ver los mensajes</h5>
            <div id="mensajes-container" class="p-2" style="max-height:500px; overflow-y:auto;">
                <p>Selecciona un alumno para ver la conversaciÃ³n y enviar un mensaje.</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

<script>
let alumnoSeleccionado = null;
let mensajesData = [];  // Todos los mensajes del usuario actual
let usuariosConversacion = {}; // Usuarios con los que ya hay conversaciÃ³n
let usuariosNoLeidos = new Set(); // IDs de usuarios con mensajes no leÃ­dos

const usuarioActualId = parseInt("{{ request.user.id }}");

// ðŸ”¹ Traer todos los mensajes al cargar la pÃ¡gina
function cargarMensajes() {
    fetch(`/api/mensajes/`)
    .then(resp => resp.json())
    .then(data => {
        mensajesData = data;

        // Construir lista de usuarios con los que se tiene conversaciÃ³n
        usuariosConversacion = {};
        data.forEach(msg => {
            if (msg.remitente_id === usuarioActualId) {
                usuariosConversacion[msg.destinatario_id] = msg.destinatario;
            } else if (msg.destinatario_id === usuarioActualId) {
                usuariosConversacion[msg.remitente_id] = msg.remitente;
            }
        });

        // Identificar usuarios con mensajes no leÃ­dos (Ãºltimo mensaje fue del otro)
        detectarUsuariosNoLeidos();

        renderizarUsuarios(Object.keys(usuariosConversacion));
    });
}

// ðŸ”¹ Detectar usuarios que tienen mensajes sin leer
function detectarUsuariosNoLeidos() {
    usuariosNoLeidos.clear();

    // Agrupamos por usuario
    const ultimosMensajes = {};

    mensajesData.forEach(msg => {
        let otroId = msg.remitente_id === usuarioActualId ? msg.destinatario_id : msg.remitente_id;

        // Guardar el Ãºltimo mensaje por usuario (segÃºn fecha)
        if (!ultimosMensajes[otroId] || new Date(msg.fecha_envio) > new Date(ultimosMensajes[otroId].fecha_envio)) {
            ultimosMensajes[otroId] = msg;
        }
    });

    // Si el Ãºltimo mensaje fue enviado POR EL OTRO, lo marcamos como no leÃ­do
    Object.keys(ultimosMensajes).forEach(uid => {
        const msg = ultimosMensajes[uid];
        if (msg.remitente_id !== usuarioActualId) {
            usuariosNoLeidos.add(parseInt(uid));
        }
    });
}

// ðŸ”¹ Renderizar usuarios en la lista lateral
function renderizarUsuarios(idsUsuarios) {
    const container = document.getElementById('usuarios-conversacion');
    container.innerHTML = '';

    if (idsUsuarios.length === 0) {
        container.innerHTML = `<li class="list-group-item text-muted">No hay conversaciones</li>`;
        return;
    }

    idsUsuarios.forEach(id => {
        const li = document.createElement('li');
        li.className = 'list-group-item usuario-item';
        li.textContent = usuariosConversacion[id];
        li.dataset.userId = id;

        // Si el usuario tiene mensajes no leÃ­dos, aplicar clase
        if (usuariosNoLeidos.has(parseInt(id))) {
            li.classList.add('no-leido');
        }

        li.onclick = () => mostrarConversacion(id);
        container.appendChild(li);
    });
}

// ðŸ”¹ Mostrar conversaciÃ³n de un usuario seleccionado
function mostrarConversacion(alumnoId) {
    alumnoSeleccionado = parseInt(alumnoId);
    const container = document.getElementById('mensajes-container');
    container.innerHTML = '';

    // Filtrar mensajes entre usuario actual y seleccionado
    const conversacion = mensajesData.filter(msg =>
        (msg.remitente_id === usuarioActualId && msg.destinatario_id === alumnoSeleccionado) ||
        (msg.remitente_id === alumnoSeleccionado && msg.destinatario_id === usuarioActualId)
    );

    // Mostrar mensajes
    conversacion.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'mensaje p-2 my-1';

        if (msg.remitente_id === usuarioActualId) {
            div.style.textAlign = 'right';
            div.innerHTML = `<span class="badge bg-primary">${msg.mensaje}</span><br><small>${msg.remitente}</small>`;
        } else {
            div.style.textAlign = 'left';
            div.innerHTML = `<small>${msg.remitente}</small><br><span class="badge bg-secondary">${msg.mensaje}</span>`;
        }
        container.appendChild(div);
    });

    // Input + botÃ³n para enviar mensaje
    const inputDiv = document.createElement('div');
    inputDiv.className = 'input-group mt-2';
    inputDiv.innerHTML = `
        <input type="text" id="mensaje-texto" class="form-control" placeholder="EscribÃ­ un mensaje...">
        <button class="btn btn-primary" type="button" onclick="enviarMensaje()">Enviar</button>
    `;
    container.appendChild(inputDiv);

    container.scrollTop = container.scrollHeight;

    // âœ… Marcar mensajes como leÃ­dos visualmente
    const li = document.querySelector(`.usuario-item[data-user-id='${alumnoId}']`);
    if (li) li.classList.remove('no-leido');

    // âœ… Quitar de la lista de no leÃ­dos
    usuariosNoLeidos.delete(parseInt(alumnoId));

    // âœ… Informar al backend que los marcamos como leÃ­dos
    fetch(`/api/mensajes/marcar_leidos/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({ remitente_id: alumnoSeleccionado })
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.success) {
            const punto = document.getElementById('mensajes-punto');
            if (punto) punto.style.display = 'none';
        }
    });
}

// ðŸ’¬ Enviar mensaje
function enviarMensaje() {
    const texto = document.getElementById('mensaje-texto').value.trim();
    if (!texto || !alumnoSeleccionado) return;

    fetch(`/api/mensajes/enviar/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
            destinatario_id: alumnoSeleccionado,
            mensaje: texto
        })
    })
    .then(resp => resp.json())
    .then(data => {
        if (data.success) {
            const container = document.getElementById('mensajes-container');
            const div = document.createElement('div');
            div.className = 'mensaje p-2 my-1';
            div.style.textAlign = 'right';
            div.innerHTML = `<span class="badge bg-primary">${texto}</span><br><small>Yo</small>`;
            container.insertBefore(div, container.lastChild);
            container.scrollTop = container.scrollHeight;

            document.getElementById('mensaje-texto').value = '';

            // Actualizar datos locales
            mensajesData.push({
                id: data.id,
                remitente_id: usuarioActualId,
                destinatario_id: alumnoSeleccionado,
                remitente: "Yo",
                destinatario: usuariosConversacion[alumnoSeleccionado],
                mensaje: texto,
                fecha_envio: new Date().toISOString()
            });
        } else {
            alert("Error: " + data.error);
        }
    });
}

// CSRF helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ðŸš€ InicializaciÃ³n
document.addEventListener('DOMContentLoaded', () => {
    const punto = document.getElementById('mensajes-punto');
    if (punto) punto.style.display = 'none';
    cargarMensajes();
});
</script>

</body>
</html>
