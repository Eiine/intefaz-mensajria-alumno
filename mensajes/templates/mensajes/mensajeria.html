<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mensajes internos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .usuario-item:hover {
            background-color: #f0f0f0;
            cursor: pointer;
        }
        .mensaje {
            border-bottom: 1px solid #ddd;
            padding: 10px;
        }
        .mensaje strong {
            color: #007bff;
        }
        #mensajes-container {
            max-height: 500px;
            overflow-y: auto;
        }
        #buscador-usuarios {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    {% include "mensajes/navbar.html" %}

<div class="container-fluid mt-4">
    <div class="row">
        <!-- ðŸ“‹ Lista de usuarios -->
        <div class="col-md-3 border-end">
            <h5>Conversaciones</h5>

            <!-- ðŸ” Buscador -->
            <input type="text" id="buscador-usuarios" class="form-control mb-2" placeholder="Buscar por nombre o DNI...">

            <ul class="list-group" id="usuarios-conversacion">
                <!-- Se cargan dinÃ¡micamente -->
            </ul>
        </div>

        <!-- ðŸ’¬ Mensajes -->
        <div class="col-md-9">
            <h5 id="titulo-chat">Selecciona un usuario</h5>
            <div id="mensajes-container" class="p-2" style="max-height:500px; overflow-y:auto;">
                <p>Selecciona un usuario para ver los mensajes.</p>
            </div>

            <div id="enviar-mensaje" class="mt-3" style="display: none;">
                <div class="input-group">
                    <input type="text" id="mensaje-texto" class="form-control" placeholder="EscribÃ­ un mensaje...">
                    <button class="btn btn-primary" type="button" onclick="enviarMensaje()">Enviar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

<script>
let usuarioSeleccionado = null;
const usuarioActualId = parseInt("{{ request.user.id }}");
let usuariosData = {}; // ðŸ”¹ Guardaremos los usuarios cargados para poder filtrarlos

// ðŸ”¹ Cargar usuarios con los que hay mensajes
function cargarUsuarios() {
    fetch(`/api/mensajes/`)
    .then(resp => resp.json())
    .then(data => {
        const container = document.getElementById('usuarios-conversacion');
        container.innerHTML = '';

        const usuariosMap = {};
        data.forEach(msg => {
            if (msg.remitente_id !== usuarioActualId) usuariosMap[msg.remitente_id] = msg.remitente;
            if (msg.destinatario_id !== usuarioActualId) usuariosMap[msg.destinatario_id] = msg.destinatario;
        });

        usuariosData = usuariosMap; // ðŸ”¸ Guardamos los usuarios cargados

        renderizarUsuarios(Object.keys(usuariosData));
    });
}

// ðŸ”¹ Renderizar usuarios (filtrados o completos)
function renderizarUsuarios(idsUsuarios) {
    const container = document.getElementById('usuarios-conversacion');
    container.innerHTML = '';

    if (idsUsuarios.length === 0) {
        container.innerHTML = `<li class="list-group-item text-muted">No hay coincidencias</li>`;
        return;
    }

    idsUsuarios.forEach(id => {
        const li = document.createElement('li');
        li.className = 'list-group-item usuario-item';
        li.textContent = usuariosData[id];
        li.onclick = () => cargarMensajes(id, usuariosData[id]);
        container.appendChild(li);
    });
}

// ðŸ”Ž Filtrar usuarios segÃºn bÃºsqueda
document.getElementById('buscador-usuarios').addEventListener('input', function() {
    const texto = this.value.trim().toLowerCase();

    if (!texto) {
        renderizarUsuarios(Object.keys(usuariosData));
        return;
    }

    const filtrados = Object.keys(usuariosData).filter(id => {
        const nombre = usuariosData[id].toLowerCase();
        return nombre.includes(texto) || id.includes(texto);
    });

    renderizarUsuarios(filtrados);
});

// ðŸ”¹ Cargar mensajes de un usuario seleccionado
function cargarMensajes(usuarioId, nombreUsuario) {
    usuarioSeleccionado = parseInt(usuarioId);
    document.getElementById('titulo-chat').innerText = `Mensajes con ${nombreUsuario}`;
    document.getElementById('enviar-mensaje').style.display = 'block';

    fetch(`/api/mensajes/`)
    .then(resp => resp.json())
    .then(data => {
        const container = document.getElementById('mensajes-container');
        container.innerHTML = '';

        const mensajes = data.filter(msg =>
            (msg.remitente_id === usuarioActualId && msg.destinatario_id === usuarioSeleccionado) ||
            (msg.remitente_id === usuarioSeleccionado && msg.destinatario_id === usuarioActualId)
        );

        if (mensajes.length === 0) {
            container.innerHTML = '<p>No hay mensajes con este usuario.</p>';
            return;
        }

        mensajes.forEach(msg => {
            const usuarioLogueadoNombre = "{{ request.user }}";
            const div = document.createElement('div');
            div.className = 'mensaje p-2 my-1';

            if (msg.remitente_id === usuarioActualId) {
                div.style.textAlign = 'right';
                div.innerHTML = `<span class="badge bg-primary">${msg.mensaje}</span><br><small>${usuarioLogueadoNombre}</small>`;
            } else {
                div.style.textAlign = 'left';
                div.innerHTML = `<small>${msg.remitente}</small><br><span class="badge bg-secondary">${msg.mensaje}</span>`;
            }

            container.appendChild(div);
        });

        container.scrollTop = container.scrollHeight;
    });
}

// ðŸ’¬ Enviar mensaje
function enviarMensaje() {
    const texto = document.getElementById('mensaje-texto').value.trim();
    if (!texto || !usuarioSeleccionado) return;

    fetch(`/api/mensajes/enviar/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({
            destinatario_id: usuarioSeleccionado,
            mensaje: texto
        })
    })
    .then(resp => resp.json())
    .then(() => {
        document.getElementById('mensaje-texto').value = '';
        cargarMensajes(usuarioSeleccionado, usuariosData[usuarioSeleccionado]);
    });
}

// CSRF helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ðŸš€ InicializaciÃ³n
cargarUsuarios();
</script>

</body>
</html>
