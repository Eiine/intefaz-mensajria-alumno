<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuración de Notificaciones</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        body { background-color: #f8f9fa; }
        main { min-height: 90vh; }
        .container { max-width: 700px; }
        .card-config { border: 1px solid #d44949; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075); }
        .section-title { color: #CC0000; font-weight: bold; margin-bottom: 15px; }
        .card-footer-custom { display: flex; justify-content: flex-end; padding: 1rem 0; }
        .toggle-container { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .toggle-container:last-of-type { border-bottom: none; }
        .toggle-switch { display: none; }
        .toggle-label { display: block; width: 45px; height: 25px; background-color: #ccc; border-radius: 15px; cursor: pointer; position: relative; transition: background-color 0.3s ease; flex-shrink: 0; }
        .toggle-label::after { content: ''; position: absolute; top: 2px; left: 2px; width: 21px; height: 21px; background-color: white; border-radius: 50%; box-shadow: 0 0 5px rgba(0,0,0,0.2); transition: transform 0.3s ease; }
        .toggle-switch:checked + .toggle-label { background-color: #CC0000; }
        .toggle-switch:checked + .toggle-label::after { transform: translateX(20px); }
        .slider-wrap { position: relative; }
        .slider-wrap::before { content: 'Nivel actual: ' attr(data-nivel); position: absolute; left: 0; top: -5px; font-size: 0.9em; color: #6c757d; }
        .form-range { background-color: transparent !important; }
    </style>
</head>
<body>
    {% include "mensajes/navbar.html" %}
    <main class="d-flex justify-content-center py-5">
        <div class="container">
            <h2 class="fw-bold text-dark mb-4"><i class="bi bi-gear-fill me-2"></i>Configuración de Notificaciones</h2>

            <!-- Preferencias Generales -->
            <div class="card p-4 mb-4 card-config">
                <h4 class="section-title"><i class="bi bi-bookmark-star-fill me-2"></i>Preferencias Generales</h4>
                <p class="text-muted">Activa o desactiva los tipos de notificaciones que deseas recibir.</p>

                <div class="toggle-container">
                    <div class="me-3">
                        <p class="mb-0 fw-bold">Tareas Pendientes</p>
                        <small class="text-muted d-block">Recibe alertas sobre entregas próximas y tareas asignadas.</small>
                    </div>
                    <input type="checkbox" id="tareas" name="config_tareas" class="toggle-switch" {% if pref.tareas_pendientes %}checked{% endif %}>
                    <label for="tareas" class="toggle-label"></label>
                </div>
                
                <div class="toggle-container">
                    <div class="me-3">
                        <p class="mb-0 fw-bold">Calificaciones Publicadas</p>
                        <small class="text-muted d-block">Sé el primero en saber cuándo tus calificaciones estén disponibles.</small>
                    </div>
                    <input type="checkbox" id="calificaciones" name="config_calificaciones" class="toggle-switch" {% if pref.calificaciones_publicadas %}checked{% endif %}>
                    <label for="calificaciones" class="toggle-label"></label>
                </div>

                <div class="toggle-container">
                    <div class="me-3">
                        <p class="mb-0 fw-bold">Eventos Académicos</p>
                        <small class="text-muted d-block">Notificaciones sobre seminarios, talleres y fechas importantes.</small>
                    </div>
                    <input type="checkbox" id="eventos" name="config_eventos" class="toggle-switch" {% if pref.eventos_academicos %}checked{% endif %}>
                    <label for="eventos" class="toggle-label"></label>
                </div>

                <div class="toggle-container">
                    <div class="me-3">
                        <p class="mb-0 fw-bold">Anuncios del Profesor</p>
                        <small class="text-muted d-block">Mantente informado sobre las comunicaciones importantes de tus profesores.</small>
                    </div>
                    <input type="checkbox" id="anuncios" name="config_anuncios" class="toggle-switch" {% if pref.anuncios_profesor %}checked{% endif %}>
                    <label for="anuncios" class="toggle-label"></label>
                </div>
            </div>

            <!-- Horarios de Notificación Agrupadas -->
            <div class="card p-4 mb-4 card-config">
                <h4 class="section-title"><i class="bi bi-clock-fill me-2"></i>Horarios de Notificación Agrupadas</h4>
                <p class="text-muted">Configura un horario para recibir un resumen de notificaciones.</p>
                
                <div class="toggle-container border-bottom-0">
                    <div class="me-3">
                        <p class="mb-0 fw-bold">Habilitar Notificaciones Agrupadas</p>
                        <small class="text-muted d-block">Recibe todas tus notificaciones importantes en un solo momento del día.</small>
                    </div>
                    <input type="checkbox" id="agrupadas" name="config_agrupadas" class="toggle-switch" {% if pref.habilitar_agrupadas %}checked{% endif %}>
                    <label for="agrupadas" class="toggle-label"></label>
                </div>
            </div>

            <!-- Canales y Prioridad -->
            <div class="card p-4 mb-4 card-config">
                <h4 class="section-title"><i class="bi bi-send-check-fill me-2"></i>Canales y Prioridad</h4>
                <p class="text-muted">Elige cómo y con qué urgencia deseas recibir tus notificaciones.</p>

                <p class="fw-bold mb-2">Canales de Entrega</p>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="email" id="canal-email" checked disabled>
                    <label class="form-check-label" for="canal-email">
                        <i class="bi bi-envelope-fill text-danger me-1"></i> Correo Electrónico (<span class="text-muted">Requerido</span>)
                    </label>
                </div>
                <div class="form-check mb-4">
                    <input class="form-check-input" type="checkbox" value="movil" id="canal-movil" {% if pref.aplicacion_movil %}checked{% endif %}>
                    <label class="form-check-label" for="canal-movil">
                         <i class="bi bi-phone-fill text-danger me-1"></i> Aplicación Móvil
                    </label>
                </div>

                <p class="fw-bold mb-2">Prioridad de Notificaciones</p>
                <small class="text-muted d-block mb-3">Ajusta el nivel general de importancia para todas las alertas (1 = baja, 100 = alta).</small>

                <div class="slider-wrap" data-nivel="{{ pref.prioridad_notificaciones }}">
                    <input type="range" min="1" max="100" value="{{ pref.prioridad_notificaciones }}" class="form-range" id="prioridad-slider" name="config_prioridad">
                </div>
                <div class="d-flex justify-content-between mt-1">
                    <small class="text-muted">Baja (1)</small>
                    <small class="text-muted">Alta (100)</small>
                </div>
            </div>

        </div>
    </main>

    <footer class="text-center py-3 border-top mt-4">
        <p class="mb-1 text-muted"><small>Recursos | Acerca de</small></p>
        <p class="mb-0 text-muted"><small>Made with <i class="bi bi-heart-fill text-danger"></i></small></p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script>
        const slider = document.getElementById('prioridad-slider');
        const sliderWrap = document.querySelector('.slider-wrap');
        const toggles = document.querySelectorAll('.toggle-switch');
        const canalMovil = document.getElementById('canal-movil');

        function updateSliderDisplay(value){
            sliderWrap.setAttribute('data-nivel', value);
            slider.style.background = `linear-gradient(to right, #CC0000 ${value}%, #ddd ${value}%)`;
        }

        updateSliderDisplay(slider.value);

        slider.addEventListener('input', () => {
            updateSliderDisplay(slider.value);
            guardarPreferencias();
        });

        toggles.forEach(input => input.addEventListener('change', guardarPreferencias));
        canalMovil.addEventListener('change', guardarPreferencias);

        function guardarPreferencias(){
            const configuracion = {
                config_tareas: document.getElementById('tareas').checked,
                config_calificaciones: document.getElementById('calificaciones').checked,
                config_eventos: document.getElementById('eventos').checked,
                config_anuncios: document.getElementById('anuncios').checked,
                config_agrupadas: document.getElementById('agrupadas').checked,
                canal_movil: canalMovil.checked,
                prioridad: slider.value
            };

            fetch("{% url 'actualizar_preferencia' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify(configuracion)
            })
            .then(res => res.json())
            .then(data => {
                if(data.success){
                    console.log(data.created ? "Preferencia creada" : "Preferencia actualizada");
                } else {
                    console.error("Error:", data.error);
                }
            })
            .catch(err => console.error("Error fetch:", err));
        }
    </script>
</body>
</html>
