{% load static %}
<nav class="navbar navbar-expand-lg fixed-top" style="background-color: #8B0000;">
    <div class="container-fluid">
        
        <a class="navbar-brand d-flex align-items-center" href="#">
            <img src='{% static "descarga.png" %}' alt="Logo" width="40" height="40" style="border-radius: 50%;">
            <span class="navbar-text fw-bold fs-5 ms-2" style="color: white;">
                Instituto del Milagro
            </span>
        </a>

        <div class="flex-grow-1"></div>

        <!-- Icono de notificaciones -->
        <a href="{% url 'mensajes' %}" class="nav-link position-relative me-3">
            <i class="bi bi-envelope-fill fs-5" style="color: white;"></i>
            <span id="mensajes-punto" class="position-absolute top-0 start-100 translate-middle p-1 bg-danger rounded-circle" style="display:none;"></span>
        </a>

        <!-- MenÃº de perfil -->
        <div class="dropdown">
            <a class="nav-link dropdown-toggle" style="color: white;" href="#" role="button" id="perfilDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-person-circle fs-5" style="color: white;"></i>
            </a>

            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="perfilDropdown">
                <li class="dropdown-item text-center fw-semibold" style="cursor: default;">
                    ðŸ‘‹ Hola, {{ user.first_name|default:user.username }}!
                </li>
                <li><hr class="dropdown-divider"></li>

                <li><a class="dropdown-item" href="{% url 'alumnos_lista' %}">Inicio</a></li>
                
                {% if user.is_staff %}
                    <li><a class="dropdown-item active" href="{% url 'panel_admin' %}">Panel admin</a></li>
                    <li><a class="dropdown-item active" href="{% url 'notificaciones' %}">Notificaciones</a></li>
                {% endif %}

                {% if not user.is_staff %}
                    <li><a class="dropdown-item" href="{% url 'configuraciones' %}">Configuraciones</a></li>
                {% endif %}

                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{% url 'logout' %}">Cerrar sesiÃ³n</a></li>
            </ul>
        </div>
    </div>

    <style>
        .dropdown-menu .dropdown-item.active {
            background-color: transparent !important;
            color: inherit !important;
        }

        .dropdown-menu .dropdown-item:hover {
            background-color: #8B0000 !important;
            color: white !important;
        }

        .badge {
            padding: 0.25em 0.4em;
        }
    </style>
</nav>

<script>
(function() {
    const usuarioActualId = parseInt("{{ request.user.id }}");
    let sonido = new Audio("{% static 'sonidos/notificacion.mp3' %}");

    // ðŸ”¹ Usamos clave distinta por usuario para evitar conflictos
    const key = 'mensajes_nuevos_' + usuarioActualId;
    
    // ðŸ”¹ Ãšltimo estado guardado, si no hay nada, null
    let ultimoEstado = localStorage.getItem(key);
    if (ultimoEstado !== null) {
        ultimoEstado = parseInt(ultimoEstado);
    } else {
        ultimoEstado = null; // primera vez que entra el usuario
    }

    function checkMensajesNuevos() {
        fetch('/api/mensajes/nuevos/')
            .then(resp => resp.json())
            .then(data => {
                const nuevos = data.nuevos || 0;
                const punto = document.getElementById('mensajes-punto');
                if (!punto) return;

                if (nuevos > 0) {
                    punto.style.display = 'inline-block';
                    
                    // ðŸ”” Solo sonar si hay un mensaje nuevo y no es la primera carga
                    if (ultimoEstado !== null && nuevos > ultimoEstado) {
                        sonido.play().catch(err => console.log("No se pudo reproducir el sonido:", err));
                    }
                } else {
                    punto.style.display = 'none';
                }

                // ðŸ”¹ Guardar estado actual en localStorage
                ultimoEstado = nuevos;
                localStorage.setItem(key, nuevos);
            })
            .catch(err => console.error('Error al consultar mensajes nuevos:', err));
    }

    // Comprobar cada 5 segundos
    checkMensajesNuevos();
    setInterval(checkMensajesNuevos, 5000);
})();


</script>
