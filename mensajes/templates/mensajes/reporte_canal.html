{% load static %}

<!DOCTYPE html>
<html>
<head>
    <title>Reporte de Notificaciones por Canal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { font-family: Arial; margin: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; border: 1px solid #ccc; text-align: center; }
        th { background: #eee; }
        .kpi-box { background: #f2f2f2; padding: 15px; margin: 20px 0; border-radius: 6px; }
        .filters label { margin-right: 10px; }
    </style>
</head>
<body>
    {% include "mensajes/navbar.html" %}

    <h1>üìä Reporte de Notificaciones por Canal</h1>

    <!-- ================= FILTROS ================= -->
    <form method="GET" class="filters mb-3">
        <label>Fecha inicio:
            <input type="date" name="fecha_inicio" value="{{ f_fecha_inicio }}">
        </label>
        <label>Fecha fin:
            <input type="date" name="fecha_fin" value="{{ f_fecha_fin }}">
        </label>
        <label>Canal:
            <select name="canal">
                <option value="">Todos</option>
                <option value="Email" {% if f_canal == "Email" %}selected{% endif %}>Email</option>
                <option value="SMS" {% if f_canal == "SMS" %}selected{% endif %}>SMS</option>
                <option value="WhatsApp" {% if f_canal == "WhatsApp" %}selected{% endif %}>WhatsApp</option>
            </select>
        </label>
        <label>Tipo de evento:
            <select name="tipo">
                <option value="">Todos</option>
                {% for t in tipos %}
                    <option value="{{ t.id }}" {% if f_tipo == t.id|stringformat:"s" %}selected{% endif %}>{{ t.nombre_tipo }}</option>
                {% endfor %}
            </select>
        </label>
        <label>Estado de env√≠o:
            <select name="estado_envio">
                <option value="">Todos</option>
                <option value="Enviado" {% if f_estado_envio == "Enviado" %}selected{% endif %}>Enviado</option>
                <option value="Fallido" {% if f_estado_envio == "Fallido" %}selected{% endif %}>Fallido</option>
                <option value="Pendiente" {% if f_estado_envio == "Pendiente" %}selected{% endif %}>Pendiente</option>
                <option value="visto" {% if f_estado_envio == "visto" %}selected{% endif %}>Visto</option>
            </select>
        </label>
        <button type="submit" class="btn btn-primary btn-sm">Filtrar</button>
    </form>

    <!-- ================= INDICADORES ================= -->
    <div class="kpi-box">
        <h3>Indicadores</h3>
        {% if canal_mas_envios %}
            <p><strong>Canal con m√°s env√≠os:</strong> {{ canal_mas_envios.tipo__canal }} ({{ canal_mas_envios.total_enviadas }} env√≠os)</p>
        {% endif %}
        {% if canal_mas_fallos %}
            <p><strong>Canal con mayor % de fallos:</strong> {{ canal_mas_fallos.tipo__canal }} ({{ canal_mas_fallos.porcentaje_fallo|floatformat:2 }}%)</p>
        {% endif %}
    </div>

    <!-- ================= TABLA ================= -->
    <table>
        <thead>
            <tr>
                <th>Canal</th>
                <th>Cantidad enviadas</th>
                <th>Cantidad fallidas</th>
                <th>% Fallo</th>
            </tr>
        </thead>
        <tbody>
            {% for item in resumen %}
            <tr>
                <td>{{ item.tipo__canal }}</td>
                <td>{{ item.total_enviadas }}</td>
                <td>{{ item.total_fallidas }}</td>
                <td>{{ item.porcentaje_fallo|floatformat:2 }}%</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4">No hay resultados con los filtros aplicados.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>